<!DOCTYPE html>
<html>
<head>
    <title>Hot-Leads - DEMO</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/styles.css">
    <link rel="stylesheet" href="/bootstrap.min.css">
    <link rel="stylesheet" href="/bootstrap-theme.min.css">
    <script src="/jquery.min.js"></script>
    <script src="/bootstrap.min.js"></script>
    <script src="/knockout-min.js"></script>
</head>
<body>
    <nav class="navbar navbar-default">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">Hot-Leads - DEMO</a>
        </div>
    </nav>

    <div id="main" class="width: 100%">

        <div id="producer" class="kafka">
            <form class="form-horizontal">
                <div><font size="5">Producer</font></div>
                <div class="form-group">
                    <label for="inputProducerTopic" class="control-label col-xs-2">Topic</label>
                    <div class="col-xs-5">
                        <input class="form-control" id="inputProducerTopic" placeholder="Topic" data-bind="value: producerTopic">
                    </div>
                </div>
                <div class="form-group">
                    <label for="inputQuote" class="control-label col-xs-2">Quote</label>
                    <div class="col-xs-10">
                        <input class="form-control" id="inputQuote" placeholder="Quote" data-bind="value: quote">
                    </div>
                </div>
                <div class="form-group">
                    <div class="col-xs-offset-2 col-xs-10">
                        <button type="submit" class="btn btn-primary" data-bind="click: clickSend">Send</button>
                    </div>
                </div>
            </form>
            <div class="tab-pane messages-outter" id="producerMessages" data-bind="visible: showProducerMessages">
                <table class="table-striped messages">
                    <tr><td><b>Time</b></td><td><b>Topic</b></td><td><b>Quote</b></td></tr>
                    <!-- ko foreach: producerMessages -->
                    <tr>
                        <td>
                            <p data-bind="text: time"></p>
                        </td>
                        <td>
                            <p data-bind="text: topic"></p>
                        </td>
                        <td>
                            <p data-bind="text: quote"></p>
                        </td>
                    </tr>
                    <!-- /ko -->
                </table>
            </div>
        </div>

        <div id="consumer" class="kafka">
            <div><font size="5">Consumer</font></div>
            <form class="form-horizontal">
                <div class="form-group">
                    <label for="inputConsumerTopic" class="control-label col-xs-2">Topic</label>
                    <div class="col-xs-5">
                        <input class="form-control" id="inputConsumerTopic" placeholder="Topic" data-bind="value: consumerTopic">
                    </div>
                </div>
                <div class="form-group">
                    <div class="col-xs-offset-2 col-xs-10">
                        <button type="submit" class="btn btn-primary" data-bind="click: clickListen">Listen</button>
                    </div>
                </div>
            </form>
            <div class="tab-pane messages-outter" id="consumerMessages" data-bind="visible: showConsumerMessages">
                <table class="table-striped messages">
                    <tr><td><b>Time</b></td><td><b>Message</b></td></tr>
                    <!-- ko foreach: consumerMessages -->
                    <tr>
                        <td>
                            <p data-bind="text: time"></p>
                        </td>
                        <td>
                            <p data-bind="text: message"></p>
                        </td>
                    </tr>
                    <!-- /ko -->
                </table>
            </div>
        </div>
    </div>

    <div style="clear:both"></div>

    <script type="text/javascript">

        Date.prototype.today = function () {
            return ((this.getDate() < 10)?"0":"") + this.getDate() +"/"+(((this.getMonth()+1) < 10)?"0":"") + (this.getMonth()+1) +"/"+ this.getFullYear();
        }

        Date.prototype.timeNow = function () {
            return ((this.getHours() < 10)?"0":"") + this.getHours() +":"+ ((this.getMinutes() < 10)?"0":"") + this.getMinutes() +":"+ ((this.getSeconds() < 10)?"0":"") + this.getSeconds() + "." + ((this.getMilliseconds() < 10)?"00":((this.getMilliseconds() < 100)?"0":"")) + this.getMilliseconds();
        }

        function ViewModel() {
            var self = this;
            self.producerTopic = ko.observable("");
            self.quote = ko.observable("");
            self.producerWebSocket = initWebSocket("ws://localhost:7080/kafka/producer");
            self.producerMessages = ko.observableArray();
            self.showProducerMessages  = ko.observable(false);
            self.consumerTopic = ko.observable("");
            self.consumerWebSocket = initWebSocket("ws://localhost:7080/kafka/consumer");
            self.consumerWebSocket.onmessage = function(event) {
                var date = new Date();
                self.consumerMessages.unshift({
                    time: ko.observable(date.today() + " @ " + date.timeNow()),
                    message: ko.observable(event.data)
                });
                self.showConsumerMessages(true);
            }
            self.consumerMessages = ko.observableArray();
            self.showConsumerMessages = ko.observable(false);

            function initWebSocket(url) {
                var websocket;
                if ('WebSocket' in window) {
                    websocket = new WebSocket(url);
                } else if ('MozWebSocket' in window) {
                    websocket = new MozWebSocket(self.webUrl);
                } else {
                    alert('WebSocket is not supported by this browser.');
                    return;
                }

                websocket.onopen = function(event) {
                    console.log('Connected to server.');
                };

                websocket.onclose = function() {
                   console.log('Disconnected from server');
                };

                websocket.onerror = function(error) {
                   console.log('WebSocket Error ' + error.data);
                };

                return websocket
            }

            self.clickSend = function() {
                var date = new Date();
                self.producerMessages.unshift({
                    time: ko.observable(date.today() + " @ " + date.timeNow()),
                    topic: ko.observable(self.producerTopic()),
                    quote: ko.observable(self.quote())
                });
                self.showProducerMessages(true);
                self.producerWebSocket.send(self.producerTopic() + ';' + self.quote())
            }

            self.clickListen = function() {
                self.consumerWebSocket.send(self.consumerTopic())
            }
        }

        ko.applyBindings(new ViewModel());

    </script>
</body>
</html>